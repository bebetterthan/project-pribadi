"""
Vulnerability Model - Extracted security findings
"""
from sqlalchemy import Column, String, DateTime, Float, Text, ForeignKey, Enum, Boolean, Index, JSON, Integer
from sqlalchemy.orm import relationship
from datetime import datetime
import enum
import uuid
from app.db.base import Base


class VulnerabilitySeverity(str, enum.Enum):
    """Vulnerability severity levels"""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class VulnerabilityStatus(str, enum.Enum):
    """Vulnerability lifecycle status"""
    OPEN = "open"
    ACKNOWLEDGED = "acknowledged"
    FIXING = "fixing"
    FIXED = "fixed"
    FALSE_POSITIVE = "false_positive"


class Vulnerability(Base):
    """Security vulnerability or finding"""
    __tablename__ = 'vulnerabilities'
    
    id = Column(String, primary_key=True, default=lambda: str(uuid.uuid4()))
    scan_id = Column(String, ForeignKey('scans.id', ondelete='CASCADE'), nullable=False, index=True)
    tool_result_id = Column(String, ForeignKey('scan_results.id', ondelete='SET NULL'), nullable=True)
    
    # Vulnerability identification
    cve_id = Column(String, nullable=True, index=True)  # CVE-2023-12345 (if applicable)
    title = Column(String, nullable=False)
    description = Column(Text, nullable=False)
    
    # Severity assessment
    severity = Column(Enum(VulnerabilitySeverity), nullable=False, index=True)
    cvss_score = Column(Float, nullable=True)  # 0.0 to 10.0
    cvss_vector = Column(String, nullable=True)  # CVSS:3.1/AV:N/AC:L/...
    priority_score = Column(Integer, nullable=True, default=0)  # Calculated 0-100 score
    
    # Location
    affected_host = Column(String, nullable=True, index=True)  # domain/IP
    affected_url = Column(Text, nullable=True)  # Full URL if web vuln
    affected_port = Column(Integer, nullable=True)
    
    # Tool information
    template_id = Column(String, nullable=True)  # Nuclei template ID
    tool_name = Column(String, nullable=True)  # Tool that discovered it
    
    # Intelligence (from enrichment)
    exploit_available = Column(Boolean, default=False)
    patch_available = Column(Boolean, default=False)
    patch_url = Column(String, nullable=True)
    references = Column(JSON, nullable=True)  # Array of URLs
    
    # Remediation
    remediation = Column(Text, nullable=True)
    
    # Workflow
    status = Column(Enum(VulnerabilityStatus), default=VulnerabilityStatus.OPEN, nullable=False, index=True)
    assigned_to = Column(String, ForeignKey('users.id', ondelete='SET NULL'), nullable=True)
    notes = Column(Text, nullable=True)
    
    # Timestamps
    discovered_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    acknowledged_at = Column(DateTime, nullable=True)
    fixed_at = Column(DateTime, nullable=True)
    verified_at = Column(DateTime, nullable=True)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relationships
    scan = relationship("Scan", back_populates="vulnerabilities")
    tool_result = relationship("ScanResult")
    assignee = relationship("User", foreign_keys=[assigned_to])
    comments = relationship("VulnerabilityComment", back_populates="vulnerability", cascade="all, delete-orphan")
    
    # Indexes for performance
    __table_args__ = (
        Index('ix_vuln_scan_severity', 'scan_id', 'severity', 'cvss_score'),
        Index('ix_vuln_status_assigned', 'status', 'assigned_to'),
        Index('ix_vuln_host_status', 'affected_host', 'status'),
    )
    
    def __repr__(self):
        return f"<Vulnerability(cve={self.cve_id}, severity={self.severity}, title={self.title[:50]})>"

